name: Build and Release APK

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'gradle/**'
      - 'build.gradle.kts'
      - '.github/workflows/build-apk.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > app/fullsound-release.jks
          echo "Keystore decoded successfully"

      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "Building signed release APK..."
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/fullsound-release.jks \
            -Pandroid.injected.signing.store.password="${KEYSTORE_PASSWORD}" \
            -Pandroid.injected.signing.key.alias="${KEY_ALIAS}" \
            -Pandroid.injected.signing.key.password="${KEY_PASSWORD}" \
            --no-daemon
          
          echo "APK built successfully"
          ls -lh app/build/outputs/apk/release/

      - name: Rename APK
        run: |
          cd app/build/outputs/apk/release
          APK_FILE=$(ls app-release.apk)
          mv "$APK_FILE" "fullsound-v${{ github.run_number }}.apk"
          cp "fullsound-v${{ github.run_number }}.apk" "fullsound-latest.apk"
          echo "APK renamed to: fullsound-v${{ github.run_number }}.apk"
          ls -lh

      - name: Generate version tag
        id: version
        run: |
          VERSION="mobile-v$(date +%Y%m%d-%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: FullSound Mobile ${{ steps.version.outputs.version }}
          body: |
            ðŸ¤– **Automated Android APK Release**
            
            **Build Information:**
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Build Number: ${{ github.run_number }}
            
            **Download:**
            - `fullsound-v${{ github.run_number }}.apk` - Versioned APK
            - `fullsound-latest.apk` - Latest version
            
            **Installation:**
            1. Download the APK file
            2. Enable "Install from Unknown Sources" on your Android device
            3. Install the APK
            
            **Commit Message:**
            ${{ github.event.head_commit.message }}
          files: |
            app/build/outputs/apk/release/fullsound-v${{ github.run_number }}.apk
            app/build/outputs/apk/release/fullsound-latest.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Backend Deployment
        run: |
          echo "Triggering deployment in FULLSOUND-SPRINGBOOT repository..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/VECTORG99/FULLSOUND-SPRINGBOOT/dispatches \
            -d '{
              "event_type": "mobile-app-released",
              "client_payload": {
                "mobile_version": "${{ steps.version.outputs.version }}",
                "apk_download_url": "https://github.com/VECTORG99/FullSound-KOTLIN/releases/download/${{ steps.version.outputs.version }}/fullsound-latest.apk",
                "commit_sha": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}"
              }
            }'
          echo "Deployment trigger sent successfully"

      - name: Build Summary
        run: |
          echo "================================"
          echo "BUILD SUMMARY"
          echo "================================"
          echo ""
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Build Number: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "APK Files:"
          echo "- fullsound-v${{ github.run_number }}.apk (versioned)"
          echo "- fullsound-latest.apk (latest)"
          echo ""
          echo "Release URL: https://github.com/VECTORG99/FullSound-KOTLIN/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Backend deployment triggered âœ“"
          echo "================================"
